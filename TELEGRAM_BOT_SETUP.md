# Налаштування Telegram бота для Xbase CRM

## Огляд

Система управління бізнесами та адміністраторами через Telegram бота з повною інтеграцією з Neon PostgreSQL та аналітикою прибутку.

## Можливості

### 1. Реєстрація бізнесів
- Реєстрація з вибором сфери діяльності (SALON, BARBERSHOP, STO, CAR_WASH, SPA, FITNESS, OTHER)
- Індивідуальна налаштування для кожного бізнесу
- Персоналізація бота (розсилки, статистика)

### 2. Управління користувачами (100-200 користувачів)
- Система ролей: OWNER, ADMIN, MANAGER, EMPLOYEE, VIEWER
- Детальні права доступу для кожної ролі
- Управління через API та Telegram інтерфейс

### 3. Аналітика прибутку
- **Поточний прибуток**: розраховується тільки з завершених візитів (status = 'Done')
- **Прогнозований прибуток**: базується на підтверджених візитах (status = 'Confirmed')
- Аналітика по типах послуг та їх маржинальності
- Ефективність рекламних кампаній

### 4. Моніторинг та сповіщення
- Автоматичні сповіщення про критичні зміни прибутку
- Попередження про відхилення від плану
- Відстеження трендів та прогнозів

## Встановлення

### 1. Встановлення залежностей

```bash
npm install telegraf
```

### 2. Створення Telegram бота

1. Відкрийте [@BotFather](https://t.me/botfather) в Telegram
2. Відправте команду `/newbot`
3. Введіть назву та username для бота
4. Скопіюйте отриманий токен

### 3. Налаштування webhook

Для кожного бізнесу потрібно налаштувати webhook:

```bash
curl -X POST "https://api.telegram.org/bot<BOT_TOKEN>/setWebhook" \
  -d "url=https://your-domain.com/api/telegram/webhook?businessId=<BUSINESS_ID>"
```

### 4. Налаштування бізнесу

Використайте API endpoint для налаштування:

```bash
POST /api/telegram/setup
{
  "businessId": "xxx",
  "botToken": "xxx:xxx",
  "chatId": "xxx", // Опціонально
  "notificationsEnabled": true
}
```

## API Endpoints

### Налаштування бота
- `POST /api/telegram/setup` - Налаштування Telegram бота для бізнесу
- `POST /api/telegram/webhook?businessId=xxx` - Webhook для отримання оновлень від Telegram

### Управління користувачами
- `POST /api/telegram/register` - Реєстрація користувача в Telegram боті
- `GET /api/telegram/users?businessId=xxx` - Список користувачів
- `PATCH /api/telegram/users` - Оновлення користувача (роль, права)

### Сповіщення
- `POST /api/telegram/send-notification` - Відправка сповіщення

## Команди бота

### Для всіх користувачів
- `/start` - Реєстрація/вхід
- `/help` - Список доступних команд

### Для перегляду статистики (VIEWER+)
- `/stats` - Загальна статистика за місяць

### Для перегляду аналітики (MANAGER+)
- `/revenue` - Детальна аналітика прибутку
- `/alerts` - Активні сповіщення

## Ролі та права доступу

| Роль | Права |
|------|-------|
| OWNER | Всі права: статистика, аналітика, сповіщення, управління користувачами, налаштування |
| ADMIN | Статистика, аналітика, сповіщення, управління користувачами |
| MANAGER | Статистика, аналітика, сповіщення |
| EMPLOYEE | Статистика |
| VIEWER | Немає доступу |

## Моніторинг

Скрипт моніторингу автоматично перевіряє сповіщення та відправляє їх користувачам:

```bash
# Запуск моніторингу
tsx scripts/telegram-monitor.ts
```

Для автоматичного запуску додайте в cron:

```bash
# Перевірка кожні 30 хвилин
*/30 * * * * cd /path/to/project && tsx scripts/telegram-monitor.ts
```

## Інтеграція з аналітикою

Бот автоматично інтегрується з існуючою системою аналітики:

- Використовує `/api/analytics/revenue` для аналітики прибутку
- Використовує `/api/analytics/alerts` для сповіщень
- Використовує `/api/analytics/campaigns` для аналітики кампаній

## Налаштування для різних сфер

Кожен бізнес може налаштувати бота через поле `telegramSettings` в моделі Business:

```json
{
  "commands": ["custom_command_1", "custom_command_2"],
  "notifications": {
    "revenueAlerts": true,
    "newAppointments": true,
    "dailyReport": true
  },
  "language": "uk"
}
```

## Безпека

- Всі дії логуються в `TelegramLog`
- Перевірка прав доступу для кожної команди
- Унікальність користувачів в межах бізнесу
- Захист від несанкціонованого доступу

## Підтримка

Для питань та підтримки звертайтеся до адміністратора системи.

