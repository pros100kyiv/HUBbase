# Що зроблено і як запустити

## Зміни в проєкті

### Реєстрація
- **Помилки реєстрації** — технічні повідомлення (БД, Prisma) не показуються користувачу; показується: «Сервіс тимчасово недоступний. Спробуйте через кілька хвилин.» (API + клієнт `sanitizeErrorMessage`).
- **ErrorToast** — таймер 5 сек не скидається при ре-рендері (використано `useRef` для `onClose`).
- **Мережеві помилки** — при `Failed to fetch` показується зрозуміле повідомлення про з’єднання.
- **Валідація** — випадок «Невірні дані бізнесу» теж показує тост і текст помилки.

### Реєстрація через Telegram
- **Сторінка `/auth/telegram`** — дані беруться з hash URL (`#id=...&first_name=...`), потім з query `data=`, потім з `window.opener` (popup).
- **Безпечний парсинг** — при не-JSON відповіді API показується повідомлення замість падіння.
- **TelegramAuthButton** — безпечний `response.json()`, `setIsLoading(false)` у `finally`, тип `business.profileCompleted` для збірки.

### Видалення акаунту (API + скрипт)
- **API `DELETE/POST /api/business/delete`** — перед видаленням бізнесу:
  1. Викликається **Telegram deleteWebhook** для токена бота (щоб той самий Telegram міг знову зареєструватися).
  2. У транзакції видаляються по черзі: SMS, AI-чат, платежі, розсилки, записи, нагадування, сегменти, аналітика, імпорти/експорти, нотатки, повідомлення соцмереж, модулі, BusinessUser, Telegram-розсилки, **TelegramUser**, **SocialIntegration**, **MasterUtilization**, майстри, послуги, клієнти, ManagementCenter, TelegramLog, TelegramVerification, PhoneDirectory, GraphRelationship, GraphNode, нарешті **Business**.
- **Скрипт `scripts/cleanup-database.ts`** — перед видаленням «старих» бізнесів для кожного з `telegramBotToken` викликається **deleteWebhook**, потім виконується видалення.

---

## Як запустити локально

1. **Зупиніть усі процеси**, що можуть тримати файли проєкту:
   - закрийте `npm run dev` та інші терминали з Node/Next;
   - за потреби закрийте Cursor/VS Code або перезапустіть їх.

2. **Згенеруйте Prisma-клієнт** (якщо раніше була помилка EPERM):
   ```bash
   cd c:\server
   npx prisma generate
   ```

3. **Збірка:**
   ```bash
   npm run build
   ```

4. **Запуск:**
   ```bash
   npm run dev
   ```
   Відкрийте в браузері: http://localhost:3000 (реєстрація — /register, вхід — /login).

---

## Якщо `prisma generate` дає EPERM

- Закрийте всі вікна терміналу та процеси Node.
- Перезапустіть комп’ютер або закрийте програми, що можуть блокувати `node_modules\.prisma\client\query_engine-windows.dll.node`.
- Потім знову виконайте:
  ```bash
  cd c:\server
  npx prisma generate
  npm run build
  npm run dev
  ```

Збірка **Next.js** (`npx next build`) вже проходить успішно; код скомпільовано, TypeScript без помилок.
