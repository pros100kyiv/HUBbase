# üîí Multi-Tenant Architecture –∑ Row Level Security (RLS)

## –û–≥–ª—è–¥

–°–∏—Å—Ç–µ–º–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **PostgreSQL Row Level Security (RLS)** –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –ø–æ–≤–Ω–æ—ó —ñ–∑–æ–ª—è—Ü—ñ—ó –¥–∞–Ω–∏—Ö –º—ñ–∂ –±—ñ–∑–Ω–µ—Å–∞–º–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.

## –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

### 1. Row Level Security (RLS)

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–æ–±–æ—Ç–∏:**
- –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è –ø–æ `business_id`
- –ë—ñ–∑–Ω–µ—Å –±–∞—á–∏—Ç—å **–¢–Ü–õ–¨–ö–ò** —Å–≤–æ—ó –¥–∞–Ω—ñ
- –Ü–∑–æ–ª—è—Ü—ñ—è –Ω–∞ —Ä—ñ–≤–Ω—ñ PostgreSQL, –Ω–µ –Ω–∞ —Ä—ñ–≤–Ω—ñ –¥–æ–¥–∞—Ç–∫—É

**–°–µ—Å—ñ–π–Ω—ñ –∑–º—ñ–Ω–Ω—ñ:**
```sql
-- –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ business_id
SELECT set_current_business_id('business-uuid-here');

-- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ business_id
SELECT get_current_business_id();
```

### 2. –¢–∞–±–ª–∏—Ü—ñ –∑ RLS

**–£–≤—ñ–º–∫–Ω–µ–Ω–æ RLS –¥–ª—è:**
- ‚úÖ `Client` - –∫–ª—ñ—î–Ω—Ç–∏
- ‚úÖ `Appointment` - –∑–∞–ø–∏—Å–∏
- ‚úÖ `Master` - —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∏
- ‚úÖ `Service` - –ø–æ—Å–ª—É–≥–∏

**–ü–æ–ª—ñ—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø—É:**
- `SELECT`: –±–∞—á–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó –∑–∞–ø–∏—Å–∏
- `INSERT`: —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å–≤–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É
- `UPDATE`: –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó –∑–∞–ø–∏—Å–∏
- `DELETE`: –≤–∏–¥–∞–ª—è—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó –∑–∞–ø–∏—Å–∏

### 3. Admin Control Center (–ê—Ä—Ö—ñ–≤)

**–¢–∞–±–ª–∏—Ü—è:** `admin_control_center`

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:**
- –ê—Ä—Ö—ñ–≤–Ω–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
- –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è **–ù–ê–í–Ü–¢–¨ –ü–Ü–°–õ–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø** –±—ñ–∑–Ω–µ—Å—É
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –¥—É–±–ª—é–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–µ—Ä–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE admin_control_center (
  id UUID PRIMARY KEY,
  business_id UUID NOT NULL,        -- –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
  business_phone TEXT,
  business_email TEXT,
  business_name TEXT,
  client_id UUID,
  client_name TEXT,
  client_phone TEXT,
  action_type TEXT,                 -- 'client_created', 'appointment_created', 'business_created'
  metadata JSONB,                   -- –î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ
  created_at TIMESTAMP
);
```

### 4. –¢—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –¥—É–±–ª—é–≤–∞–Ω–Ω—è

**–¢—Ä–∏–≥–µ—Ä–∏:**
1. `trigger_sync_client_to_admin_control` - –ø—ñ—Å–ª—è INSERT –≤ `Client`
2. `trigger_sync_appointment_to_admin_control` - –ø—ñ—Å–ª—è INSERT –≤ `Appointment`
3. `trigger_sync_business_to_admin_control` - –ø—ñ—Å–ª—è INSERT –≤ `Business`

**–©–æ —Ä–æ–±–∏—Ç—å —Ç—Ä–∏–≥–µ—Ä:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–ø—ñ—é—î –¥–∞–Ω—ñ –≤ `admin_control_center`
- –ó–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –±—ñ–∑–Ω–µ—Å—É —Ç–∞ –∫–ª—ñ—î–Ω—Ç–∞
- –î–æ–¥–∞—î –º–µ—Ç–∞–¥–∞–Ω—ñ (action_type, metadata)

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è business_id –¥–ª—è RLS

```typescript
import { setCurrentBusinessId, executeWithRLS } from '@/lib/database/rls-helper'

// –í–∞—Ä—ñ–∞–Ω—Ç 1: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
await setCurrentBusinessId(businessId)

// –í–∞—Ä—ñ–∞–Ω—Ç 2: –í–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞–ø–∏—Ç –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è–º
const clients = await executeWithRLS(businessId, async () => {
  return await prisma.client.findMany()
})

// –í–∞—Ä—ñ–∞–Ω—Ç 3: Middleware
const withRLS = withRLS(businessId)
const clients = await withRLS(() => prisma.client.findMany())
```

### API Routes –∑ RLS

```typescript
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const businessId = searchParams.get('businessId')

  if (!businessId) {
    return NextResponse.json({ error: 'businessId is required' }, { status: 400 })
  }

  // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ business_id –¥–ª—è RLS
  await setCurrentBusinessId(businessId)

  // –¢–µ–ø–µ—Ä –≤—Å—ñ –∑–∞–ø–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å—Å—è –ø–æ business_id
  const clients = await prisma.client.findMany()

  return NextResponse.json(clients)
}
```

## –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ—ó

```bash
npm run db:apply-rls
```

–¶–µ–π —Å–∫—Ä–∏–ø—Ç:
- –°—Ç–≤–æ—Ä—é—î —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è RLS
- –£–≤—ñ–º–∫–Ω—é—î RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—å
- –°—Ç–≤–æ—Ä—é—î –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø—É
- –°—Ç–≤–æ—Ä—é—î —Ç—Ä–∏–≥–µ—Ä–∏ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è
- –°—Ç–≤–æ—Ä—é—î —Ç–∞–±–ª–∏—Ü—é `admin_control_center`

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ RLS

```sql
-- –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ business_id
SELECT set_current_business_id('your-business-id'::UUID);

-- –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤
SELECT * FROM "Client";
-- –ü–æ–≤–µ—Ä–Ω–µ —Ç—ñ–ª—å–∫–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ü—å–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É

-- –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤ —ñ–Ω—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É
-- –ü–æ–≤–µ—Ä–Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (RLS –±–ª–æ–∫—É—î)
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç—Ä–∏–≥–µ—Ä—ñ–≤

```sql
-- –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
INSERT INTO "Client" (id, "businessId", name, phone)
VALUES (gen_random_uuid(), 'your-business-id', 'Test Client', '+380123456789');

-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –∑–∞–ø–∏—Å –∑'—è–≤–∏–≤—Å—è –≤ admin_control_center
SELECT * FROM admin_control_center 
WHERE client_phone = '+380123456789';
```

## –í–∞–∂–ª–∏–≤—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è

‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û:**

1. **–ó–∞–≤–∂–¥–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–π—Ç–µ business_id –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Ç–∞–º–∏**
   - –ë–µ–∑ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è business_id RLS –º–æ–∂–µ –±–ª–æ–∫—É–≤–∞—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Ç–∏
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `setCurrentBusinessId()` –∞–±–æ `executeWithRLS()`

2. **–°–∏—Å—Ç–µ–º–Ω—ñ –∑–∞–ø–∏—Ç–∏**
   - –î–ª—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è) –º–æ–∂–Ω–∞ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ business_id
   - –ü–æ–ª—ñ—Ç–∏–∫–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∑–∞–ø–∏—Ç–∏ –∑ `get_current_business_id() IS NULL`

3. **–¢—Ä–∏–≥–µ—Ä–∏ –ø—Ä–∞—Ü—é—é—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**
   - –í—Å—ñ –Ω–æ–≤—ñ –∫–ª—ñ—î–Ω—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥—É–±–ª—é—é—Ç—å—Å—è –≤ `admin_control_center`
   - –í—Å—ñ –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥—É–±–ª—é—é—Ç—å—Å—è –≤ `admin_control_center`
   - –í—Å—ñ –Ω–æ–≤—ñ –±—ñ–∑–Ω–µ—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥—É–±–ª—é—é—Ç—å—Å—è –≤ `admin_control_center`

4. **–ê—Ä—Ö—ñ–≤–Ω—ñ –¥–∞–Ω—ñ**
   - `admin_control_center` –∑–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –±—ñ–∑–Ω–µ—Å—É
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ —Ç–∞ –∞—É–¥–∏—Ç—É

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

```
Business (UUID)
  ‚Üì
Client (–∑ RLS) ‚Üí admin_control_center (–∞—Ä—Ö—ñ–≤)
  ‚Üì
Appointment (–∑ RLS) ‚Üí admin_control_center (–∞—Ä—Ö—ñ–≤)
  ‚Üì
Master (–∑ RLS)
  ‚Üì
Service (–∑ RLS)
```

## –ë–µ–∑–ø–µ–∫–∞

‚úÖ **–ì–∞—Ä–∞–Ω—Ç—ñ—ó:**
- –Ü–∑–æ–ª—è—Ü—ñ—è –¥–∞–Ω–∏—Ö –Ω–∞ —Ä—ñ–≤–Ω—ñ PostgreSQL
- –ù–µ–º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —á—É–∂–∏—Ö –¥–∞–Ω–∏—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤
- –ê—Ä—Ö—ñ–≤–Ω—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –æ–∫—Ä–µ–º–æ

